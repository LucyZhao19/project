In my final project, I used Flask to execute the webpage. I used snakemake (https://snakemake.readthedocs.io/en/stable/index.html) to build the pipeline that identifies DNA mutations present in a specific chromosome of a given sample. I have also made a environment.yaml file that specifies the packages needed for the conda environment “snakemakeCS50”. To build the yaml file, I modeled after this tutorial: https://www.embl.org/groups/bioinformatics-rome/blog/2022/03/snakemake-profile-1-getting-started-with-snakemake/

On the home page (index.html), when the user submits a sample and reference chromosome input (submitted via “POST”), app.py first checks if the submitted sample and reference input is valid. If either input is empty, gives an error, and/or does not meet the expected file type or name (i.e. sample should have .fastq extension, and the reference should match any one of the possible chromosome references [chr1 to chr22]), app.py displays error.html.

If the user input is valid, app.py proceeds to delete any previous snakemake outputs (to prevent the output of the current snakemake execution from being mixed up with previous ones). Then, app.py saves the user-selected fastq filename and human reference chromosome name into a csv file called “user_input.csv”, where the “sample” column lists the sample name and the “reference” column lists the corresponding chromosome name. Subsequently, app.py executes the snakemake command (snakemake --forceall --cores 3) through the command-line interface. 

The snakemake command executes Snakefile, which first stores the sample and chromosome reference of the “user_input.csv” into the list “SAMPLE” and “REFERENCE”. The expand() function refers to the {sample} and {reference} variable to the sample(s) stored in SAMPLE and the reference(s) stored in REFERENCE. For a given rule, the indented lines under “input:” refer to the location of the input files, the indented lines under “output:” specify the location and filename of the desired output, and the indented lines under “shell:” specify the command-line interface commands. As mutation calling requires multiple steps, the rules are listed in sequential order, where the output of the previous rule (e.g. “bam_files/{sample}.bam” of rule align_and_sort_reads) serves as the input to the subsequent rule (e.g. rule index_bam). 

The mutation calling pipeline is executed in the following sequential manner:
-	In rule align_and_sort_reads, bwa mem aligns reads of the selected sample (e.g. A.fastq file) to the user-specified human reference chromosome (e.g. chr9.fa) and generates a SAM file (https://bio-bwa.sourceforge.net/). Subsequently, samtools sort re-orders reads of the SAM output by the position and chromosome number (e.g., reads located at the first base-pair of chromosome 1 will be the first read in the sorted BAM file) and outputs a sorted BAM file in the “bam_files” folder (https://www.htslib.org/doc/samtools-sort.html). 
-	In rule index_bam, samtools index generates a BAM.BAI file, which allows efficient identification of all reads that are mapped to a particular chromosomal region (https://www.htslib.org/doc/samtools-index.html). 
-	In rule call_mutation, bcftools mpileup uses the specified reference chromosome and the sample’s BAM and BAM.BAI files (that are generated from the previous rule) to identify the most probable nucleotide (A/C/T/G) at each base pair of the sample. Then, the bcftools call identifies the mutations and the corresponding position and outputs the information in a .txt file (https://www.chg.ox.ac.uk/~gav/projects/oxford_statgen_summer_school/website/next_generation_sequencing/mutation_calling_and_imputation/Mutation_calling/). 
-	Upon successful completion of the mutation calling pipeline, snakefile generates a report.html, which contains the mutation calling workflow and the code for each rule. 

After the snakemake command finishes running, snakemake’s output .txt file (which contains a list of mutations) and the report.html is displayed in result.html, and the user can freely download the .txt file and report.html from the website. The user can also return to the homepage by clicking on the “Home” tab. 
